<style>
  .gefi-workflow-svg {
    width: 100%;
    max-width: 900px; /* Reduced max-width for less blank space */
    display: block;
    margin: 0 auto;
    overflow: visible;
  }
  .gefi-workflow-wrapper {
    background: transparent;
    padding: 20px 0; /* Reduced padding */
    text-align: center;
  }

  /* Default = dark theme */
  .gefi-node {
    fill: #ffffff;
    stroke: #777777;
    stroke-width: 2;
    rx: 16;
    ry: 16;
  }
  .gefi-text {
    fill: #ffffff;
    font-family: system-ui, -apple-system, sans-serif;
  }
  .gefi-arrow {
    stroke: #bbbbbb;
    stroke-width: 3;
    fill: none;
  }
  .gefi-input-group {
    fill: #4CAF50;
    stroke: #388E3C;
    stroke-width: 2;
    rx: 12;
    ry: 12;
  }
  .gefi-compliance-node {
    fill: #FF9800;
    stroke: #E65100;
  }
  .gefi-feedback-arrow-label {
    fill: #ffffff; /* White for dark theme */
    font-size: 14px;
    font-weight: 500;
    font-family: system-ui, -apple-system, sans-serif;
  }

  /* Light theme override */
  @media (prefers-color-scheme: light) {
    .gefi-node {
      fill: #f0f0f0 !important;
      stroke: #444444 !important;
    }
    .gefi-text {
      fill: #111111 !important;
    }
    .gefi-arrow {
      stroke: #555555 !important;
    }
    .gefi-input-group {
      fill: #DCF8E0 !important;
      stroke: #388E3C !important;
    }
    .gefi-compliance-node {
      fill: #FFF3E0 !important;
      stroke: #E65100 !important;
    }
    .gefi-feedback-arrow-label {
      fill: #111111 !important; /* Dark for light theme */
    }
  }
</style>

<div class="gefi-workflow-wrapper">
<svg class="gefi-workflow-svg" viewBox="0 0 900 680" preserveAspectRatio="xMidYMid meet">
  <defs>
    <marker id="arrowhead" markerWidth="12" markerHeight="10" refX="10" refY="5" orient="auto" style="color: currentColor;">
      <path d="M0,0 L10,5 L0,10 Z" style="fill: currentColor;"/>
    </marker>
  </defs>

  <rect x="250" y="20" width="400" height="70" rx="12" class="gefi-input-group" />
  <text x="450" y="58" text-anchor="middle" class="gefi-text" style="font-size:20px; font-weight:700;">Stakeholders (Devs + FIs + Data Providers)</text>
  
  <rect x="300" y="120" width="300" height="70" rx="16" class="gefi-node"/>
  <text x="450" y="148" text-anchor="middle" class="gefi-text" style="font-size:22px; font-weight:600;">Local Model Agents</text>
  <text x="450" y="175" text-anchor="middle" class="gefi-text" style="font-size:15px; opacity:0.9;">(Training on private, I-device data)</text>

  <rect x="300" y="220" width="300" height="70" rx="16" class="gefi-node"/>
  <text x="450" y="248" text-anchor="middle" class="gefi-text" style="font-size:22px; font-weight:600;">Federated Learning Orchestrator</text>
  <text x="450" y="275" text-anchor="middle" class="gefi-text" style="font-size:15px; opacity:0.9;">(Manages update cycles & encryption)</text>

  <rect x="300" y="320" width="300" height="70" rx="16" class="gefi-node"/>
  <text x="450" y="348" text-anchor="middle" class="gefi-text" style="font-size:22px; font-weight:600;">Secure Aggregation Layer</text>
  <text x="450" y="375" text-anchor="middle" class="gefi-text" style="font-size:15px; opacity:0.9;">(FedAvg, FedProx, HE, DP, ZKPs)</text>
  
  <rect x="300" y="420" width="300" height="70" rx="16" class="gefi-compliance-node"/>
  <text x="450" y="448" text-anchor="middle" class="gefi-text" style="font-size:22px; font-weight:600;">Compliance Engine</text>
  <text x="450" y="475" text-anchor="middle" class="gefi-text" style="font-size:15px; opacity:0.9;">(Pre-distribution review)</text>

  <rect x="640" y="420" width="230" height="70" rx="16" class="gefi-compliance-node"/>
  <text x="755" y="448" text-anchor="middle" class="gefi-text" style="font-size:22px; font-weight:600;">Regulator Notifier</text>
  <text x="755" y="475" text-anchor="middle" class="gefi-text" style="font-size:15px; opacity:0.9;">(Reporting & Auditing)</text>
  
  <rect x="300" y="520" width="300" height="70" rx="16" class="gefi-node"/>
  <text x="450" y="548" text-anchor="middle" class="gefi-text" style="font-size:22px; font-weight:600;">Contribution Ledger</text>
  <text x="450" y="575" text-anchor="middle" class="gefi-text" style="font-size:15px; opacity:0.9;">(Smart Contracts, Provenance, Rating)</text>

  <rect x="300" y="620" width="300" height="70" rx="16" class="gefi-node"/>
  <text x="450" y="648" text-anchor="middle" class="gefi-text" style="font-size:22px; font-weight:600;">GeFi Marketplace</text>
  <text x="450" y="675" text-anchor="middle" class="gefi-text" style="font-size:15px; opacity:0.9;">(Model Exchange, Rewards Distribution)</text>

  
  <line x1="450" y1="90" x2="450" y2="120" class="gefi-arrow" marker-end="url(#arrowhead)"/>
  
  <line x1="450" y1="190" x2="450" y2="220" class="gefi-arrow" marker-end="url(#arrowhead)"/>
  <text x="530" y="210" text-anchor="start" class="gefi-text" style="font-size:14px; opacity:0.8;">Encrypted Updates</text>

  <line x1="450" y1="290" x2="450" y2="320" class="gefi-arrow" marker-end="url(#arrowhead)"/>

  <line x1="450" y1="390" x2="450" y2="420" class="gefi-arrow" marker-end="url(#arrowhead)"/>
  
  <line x1="600" y1="455" x2="640" y2="455" class="gefi-arrow" marker-end="url(#arrowhead)"/>

  <line x1="450" y1="490" x2="450" y2="520" class="gefi-arrow" marker-end="url(#arrowhead)"/>

  <line x1="450" y1="590" x2="450" y2="620" class="gefi-arrow" marker-end="url(#arrowhead)"/>


  <path d="M 600 655 H 800 V 100 H 650" class="gefi-arrow" marker-end="url(#arrowhead)"/>
  <text x="750" y="380" text-anchor="middle" class="gefi-feedback-arrow-label">New Global Model</text>
  <text x="750" y="400" text-anchor="middle" class="gefi-feedback-arrow-label">& Rewards Distribution</text>

  <path d="M 300 655 H 100 V 155 H 300" class="gefi-arrow" marker-end="url(#arrowhead)"/>
  <text x="100" y="380" text-anchor="middle" class="gefi-feedback-arrow-label" transform="rotate(-90 100 380)">Model Utilization & Feedback</text>

</svg>
</div>